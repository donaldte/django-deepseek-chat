{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>Chat - {{ project.name }}</h2>
    
    <div id="chat-box">
        {% for msg in messages %}
        <div class="message user-message"><strong>Vous :</strong> {{ msg.message }}</div>
        <div class="message ai-response"><strong>DeepSeek :</strong> {{ msg.response }}</div>
        {% endfor %}
    </div>

    <!-- Formulaire -->
    <form id="chat-form">
        <input type="text" id="message-input" class="form-control" required>
        <button type="submit" class="btn btn-primary mt-2">Envoyer</button>
    </form>
</div>

<!-- Script WebSocket -->
<script>
    var chatSocket = new WebSocket("ws://" + window.location.host + "/ws/chat/{{ project.id }}/");

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var chatBox = document.getElementById("chat-box");
        
        if (data.sender === "user") {
            chatBox.innerHTML += `<div class="message user-message"><strong>Vous :</strong> ${data.message}</div>`;
        } else if (data.sender === "ai") {
            let aiMessage = document.querySelector(".message.ai-response:last-child");
            if (!aiMessage) {
                chatBox.innerHTML += `<div class="message ai-response"><strong>DeepSeek :</strong> ${data.message}</div>`;
            } else {
                aiMessage.innerHTML = `<strong>DeepSeek :</strong> ${data.message}`;
            }
        }
    };

    document.getElementById("chat-form").onsubmit = function(event) {
        event.preventDefault();
        var messageInput = document.getElementById("message-input");
        chatSocket.send(JSON.stringify({"message": messageInput.value}));
        messageInput.value = "";
    };
</script>
{% endblock %}
